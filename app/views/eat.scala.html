@(day: Option[Int], month: Option[Int], year: Option[Int], macroEntries: List[MacroEntry], macroEntryForm: Form[(Option[String], Int, Int, Int, Int, Int, Int, Int)], macroEntryByFoodForm: Form[(String, Int, Int, Int, Int)], dateFilterForm: Form[(Int, Int, Int)])

@import helper._
@import helper.twitterBootstrap2._
@import helper.twitterBootstrap2.Bootstrap2Helpers._
@import models.Date

@main(Html("Superbeefcake!")) {
	@bs2Row() {
		@form(routes.Application.submitDateFilter, ('class, "form-vertical")) {
			@bs2Span(3, Some(1)) {
				<fieldset>
					<legend>Choose your date</legend>
					<div class="control-group">
						<div class="controls">
							<select class="span1" name="day">
								@{for(i <- 1 to 31) yield 
									if(i == day.get) Html("<option selected='selected'>" + i.toString + "</option>")
									else Html("<option>" + i.toString + "</option>")
								}
							</select>
							<select class="span1" name="month">
								@{for(i <- 1 to 12) yield
									if(i == month.get) Html("<option selected='selected'>" + i.toString + "</option>")
									else Html("<option>" + i.toString + "</option>")
								}
							</select>
							<select class="span1" name="year">
								@{for(i <- 2012 to 2012) yield
									if(i == year.get) Html("<option selected='selected'>" + i.toString + "</option>")
									else Html("<option>" + i.toString + "</option>")
								}
							</select>
							<script type="text/javascript" charset="utf-8">
								$(function() {
									$("select[name='day'], select[name='month'], select[name='year']").change(function(){
										$(this).closest("form").submit();
									});
								});
							</script>
						</div>
					</div>
				</fieldset>
			}
			@bs2Span(3, Some(1)) {
				<div id="placeholder" style="width: 250px; height: 150px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; position: relative; "></div>
				<script type="text/javascript" charset="utf-8">
					$(function () {
						var protein = @macroEntries.map(_.protein).foldLeft(0.0)((a,b) => a+b);
						var fat = @macroEntries.map(_.fat).foldLeft(0.0)((a,b) => a+b);
						var carbs = @macroEntries.map(_.carbs).foldLeft(0.0)((a,b) => a+b);
						if(protein + fat + carbs > 0) {
							$.plot($("#placeholder"), [{label: "Protein", color: "green", data: protein}, {label: "Fat", color: "red", data:  fat}, {label: "Carbs", color: "blue", data: carbs}], {
							series: {
								pie: {
									show: true,
									tilt: 0.5
									}
							},
							legend: {
								show: false
							}
							});
						}
					});
				</script>
			}
		}
	}

	@{/* TODO create a template for this */}
	@{/* tracking pange */}
	@bs2Row('id->"track-row") {
		@bs2Span(8, Some(1)) {
			@bs2Table(List(Html(""),Html("kCal"), Html("Protein"), Html("Fat"), Html("Carbs"), Html("")), 'class -> "table-condensed table-striped") {
				@form(routes.Application.submitMacroEntry, ('class -> "form-horizontal")) {
					<tr>
						@{/* TODO make sure the hidden field is synchronized with the other date field */}
						<input type="hidden" name="day" value="@{day match { case None => Date().day; case Some(day) => day}}" />
						<input type="hidden" name="month" value="@{month match { case None => Date().month; case Some(month) => month}}" />
						<input type="hidden" name="year" value="@{year match { case None => Date().year; case Some(year) => year}}" />
						<td>@bs2TextField("food", 3, Some("Label"))</td>
						<td>@bs2TextField("kCal", 1, Some("kCal"))</td>
						<td>@bs2TextField("protein", 1, Some("protein"))</td>
						<td>@bs2TextField("fat", 1, Some("fat"))</td>
						<td>@bs2TextField("carbs", 1, Some("carbs"))</td>
						<td><input type="submit" value="Add" class="btn" /></td>
					</tr>
				}
				@form(routes.Application.submitMacroEntryByFood, ('class->"form-horizontal")) {
					<tr>
						<input type="hidden" name="day" value="@{day match { case None => Date().day; case Some(day) => day}}" />
						<input type="hidden" name="month" value="@{month match { case None => Date().month; case Some(month) => month}}" />
						<input type="hidden" name="year" value="@{year match { case None => Date().year; case Some(year) => year}}" />
						<td><input type="text" name="foodName" class="span3" placeholder="Food" data-provide="typeahead" autocomplete="off" /></td>
						<td colspan="2">@bs2TextField("amount", 2, Some("Amount"))</td>
						<td></td>
						<td></td>
						<td><input type="submit" value="Add" class="btn" /></td>
					</tr>
				}
				@macroEntries.map{macroEntry => 
					<tr>
						<td>@{macroEntry.food match {case None => ""; case Some(food) => food}}</td>
						<td>@macroEntry.kCal.toInt.toString</td>
						<td>@macroEntry.protein.toInt.toString</td>
						<td>@macroEntry.fat.toInt.toString</td>
						<td>@macroEntry.carbs.toInt.toString</td>
						<td>
							<a href="@{routes.Application.deleteEntry(macroEntry.id.get)}" style="font-weight: bold; font-size: 16px; line-height: 16px; color: black; text-shadow: 0 1px 0 white; opacity: 0.2;">x</a>
						</td>
					</tr>
				}
				<tr>
					<td><strong>Total</strong></td>
					<td><strong>@macroEntries.map(_.kCal).foldLeft[Double](0)(_+_).toInt</strong></td>
					<td><strong>@macroEntries.map(_.protein).foldLeft[Double](0)(_+_).toInt</strong></td>
					<td><strong>@macroEntries.map(_.fat).foldLeft[Double](0)(_+_).toInt</strong></td>
					<td><strong>@macroEntries.map(_.carbs).foldLeft[Double](0)(_+_).toInt</strong></td>
					<td></td>
				</tr>
			}
		}
	}

	@{/* TODO create a template for this */}
	@{/* Analyze pane */}
	@bs2Row('id->"analyze-row") {
	}

	<script type="text/javascript" charset="utf-8">
		$(function(){
			// select the navbar link for this view as active
			$("#eat-nav-link").closest("li").addClass("active");

			// typeahead
			$("input[name='foodName']").typeahead({source: function(typeahead, query) {
				var url = '@routes.Application.suggestFood("")';
				console.log("Getting new suggestions...");
				$.getJSON(url + query, function(response) {
					console.log("New suggestions: " + response.items);
					typeahead.process(response.items);
				});
			}
			, matcher: function(item) {
				// all of the words in the query need to appear in the item
				var queryWords = this.query.split(" ");
				var found = true;
				for(word in queryWords) {
					var itemUpper = item.toUpperCase();
					var wordUpper = queryWords[word].toUpperCase();
					if(itemUpper.indexOf(wordUpper) ==  -1) found = false;
				}
				return found;
			}
			});

			// focus the food input field
			$("input[name='foodName']").focus();
		});
	</script>
}
